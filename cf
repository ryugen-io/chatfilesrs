#!/bin/bash
# Chatfile tool for Claude Code
# Usage:
#   cf create-room [name]   - Create a new room (name.Chatfile or Chatfile)
#   cf list-rooms           - List available rooms
#   cf register <chatfile>  - Register with chatfile
#   cf join                 - Join the room (announces entry)
#   cf leave                - Leave the room (announces exit)
#   cf send "message"       - Send message
#   cf await                - Wait for new message
#   cf read                 - Show recent messages
#
# State stored in .cf_session (no env vars needed)

set -e

CMD="${1:-help}"
shift 2>/dev/null || true

find_session() {
    if [ -f ".cf_session" ]; then
        echo ".cf_session"
    elif [ -f "$HOME/.cf_session" ]; then
        echo "$HOME/.cf_session"
    else
        return 1
    fi
}

load_session() {
    local sf
    sf=$(find_session) || { echo "No session. Run: cf register <chatfile>" >&2; exit 1; }
    read -r CHATFILE < "$sf"
    read -r MYNAME < <(sed -n '2p' "$sf")
    JOINED=$(sed -n '3p' "$sf")
}

save_session() {
    local sf
    sf=$(find_session) || sf=".cf_session"
    printf '%s\n%s\n%s\n' "$CHATFILE" "$MYNAME" "$JOINED" > "$sf"
}

case "$CMD" in
    create-room|create|cr)
        NAME="${1:-}"
        if [ -n "$NAME" ]; then
            CHATFILE="${NAME}.Chatfile"
        else
            CHATFILE="Chatfile"
        fi

        if [ -f "$CHATFILE" ]; then
            echo "Room already exists: $CHATFILE" >&2
            exit 1
        fi

        printf '[system %s]: Chatroom "%s". Format: Name: msg. Append only.\n' "$(date '+%F %T')" "${NAME:-default}" > "$CHATFILE"

        # Make append-only (requires sudo)
        if sudo chattr +a "$CHATFILE" 2>/dev/null; then
            echo "Created room: $CHATFILE (append-only)"
        else
            echo "Created room: $CHATFILE (append-only failed - run: sudo chattr +a $CHATFILE)"
        fi
        ;;

    list-rooms|list|ls)
        echo "Available rooms:"
        shopt -s nullglob
        for f in *.Chatfile Chatfile; do
            [ -f "$f" ] && echo "  $f"
        done
        shopt -u nullglob
        ;;

    register|reg|r)
        CHATFILE="${1:-Chatfile}"
        CHATFILE=$(realpath "$CHATFILE" 2>/dev/null || echo "$CHATFILE")

        [ -f "$CHATFILE" ] || { echo "Chatfile not found: $CHATFILE" >&2; exit 1; }

        ADJS=(swift bold calm keen sage wild bright dark quick slow)
        NOUNS=(fox owl raven wolf bear hawk crane lynx deer hare)

        attempts=0
        while [ $attempts -lt 100 ]; do
            adj="${ADJS[RANDOM % ${#ADJS[@]}]}"
            noun="${NOUNS[RANDOM % ${#NOUNS[@]}]}"
            suffix=$((RANDOM % 9000 + 1000))
            MYNAME="${adj}-${noun}-${suffix}"
            grep -q "^${MYNAME}:" "$CHATFILE" 2>/dev/null || break
            ((attempts++))
        done

        JOINED=""
        printf '%s\n%s\n%s\n' "$CHATFILE" "$MYNAME" "$JOINED" > .cf_session
        echo "$MYNAME"
        ;;

    join|j)
        load_session
        [ -n "$JOINED" ] && { echo "Already joined as $MYNAME" >&2; exit 1; }
        JOINED="yes"
        save_session
        printf '[%s joined]\n' "$MYNAME" >> "$CHATFILE"
        echo "Joined as $MYNAME"
        ;;

    leave|l)
        load_session
        [ -z "$JOINED" ] && { echo "Not in room" >&2; exit 1; }
        printf '[%s left]\n' "$MYNAME" >> "$CHATFILE"
        JOINED=""
        save_session
        echo "Left room"
        ;;

    send|s)
        [ -z "$1" ] && { echo "Usage: cf send \"message\"" >&2; exit 1; }
        load_session
        [ -z "$JOINED" ] && { echo "Must join first: cf join" >&2; exit 1; }
        printf '%s: %s\n' "$MYNAME" "$1" >> "$CHATFILE"
        ;;

    await|a|wait|w)
        load_session
        [ -z "$JOINED" ] && { echo "Must join first: cf join" >&2; exit 1; }
        LAST=$(tail -n 1 "$CHATFILE" | cut -d: -f1)
        if [ "$LAST" = "$MYNAME" ]; then
            tail -f -n 0 "$CHATFILE" | head -n 1
        else
            tail -n 1 "$CHATFILE"
        fi
        ;;

    send-await|sa)
        [ -z "$1" ] && { echo "Usage: cf send-await \"message\"" >&2; exit 1; }
        load_session
        [ -z "$JOINED" ] && { echo "Must join first: cf join" >&2; exit 1; }
        printf '%s: %s\n' "$MYNAME" "$1" >> "$CHATFILE"
        tail -f -n 0 "$CHATFILE" | head -n 1
        ;;

    read|cat)
        load_session
        tail -n "${1:-20}" "$CHATFILE"
        ;;

    status|st)
        if sf=$(find_session 2>/dev/null); then
            read -r CHATFILE < "$sf"
            read -r MYNAME < <(sed -n '2p' "$sf")
            JOINED=$(sed -n '3p' "$sf")
            echo "Session: $MYNAME"
            echo "Chatfile: $CHATFILE"
            echo "Joined: ${JOINED:-no}"
        else
            echo "No active session"
            exit 1
        fi
        ;;

    help|--help|-h|*)
        cat <<'EOF'
cf - Chatfile tool for Claude Code

Room management:
  cf create-room [name]   Create room (name.Chatfile), append-only
  cf list-rooms           List available rooms
  cf register <chatfile>  Register with a chatfile
  cf join                 Join the room (announces entry)
  cf leave                Leave the room (announces exit)

Messaging:
  cf send "message"       Send a message
  cf await                Wait for next message
  cf send-await "msg"     Send and wait for reply
  cf read [n]             Show last n messages (default 20)

Info:
  cf status               Show current session

State stored in .cf_session (current directory)
EOF
        ;;
esac
